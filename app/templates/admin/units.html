{% extends "admin/base_admin.html" %}

{% block page_title %}Ünite Yönetimi{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('pages.admin_pages.curriculum_management') }}">Müfredat</a></li>
    <li class="breadcrumb-item active">Üniteler</li>
{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" onclick="showAddModal()">
    <i class="fas fa-plus"></i> Yeni Ünite
</button>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-cubes"></i> Ünite Listesi
        </h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="subjectFilter" class="form-label">Ders Seçiniz</label>
                <select class="form-select" id="subjectFilter" onchange="loadUnits()">
                    <option value="">Tüm Dersler</option>
                    <!-- Subjects will be populated by JavaScript -->
                </select>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover" id="unitsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Ünite Adı</th>
                        <th>Ders</th>
                        <th>Sıra No</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="unitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Yeni Ünite</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="unitForm">
                    <input type="hidden" id="unitId">
                    <div class="mb-3">
                        <label for="unitName" class="form-label">Ünite Adı</label>
                        <input type="text" class="form-control" id="unitName" required>
                    </div>
                    <div class="mb-3">
                        <label for="subjectSelect" class="form-label">Ders</label>
                        <select class="form-select" id="subjectSelect" required>
                            <option value="">Ders seçiniz</option>
                            <!-- Subjects will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="orderNumber" class="form-label">Sıra Numarası</label>
                        <input type="number" class="form-control" id="orderNumber" min="1" required>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="isActive" checked>
                        <label class="form-check-label" for="isActive">Aktif</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveButton" onclick="saveUnit()">Kaydet</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Initialize the page when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable
    const unitsTable = $('#unitsTable').DataTable({
        ajax: {
            url: '/api/admin/units',
            dataSrc: 'data'
        },
        columns: [
            { data: 'id' },
            { data: 'name' },
            { data: 'subject_name' },
            { data: 'order_number' },
            { 
                data: 'is_active',
                render: function(data, type, row) {
                    return data ? 
                        '<span class="badge bg-success">Aktif</span>' : 
                        '<span class="badge bg-danger">Pasif</span>';
                }
            },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    return `
                        <button class="btn btn-sm btn-outline-primary" onclick="editUnit(${row.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUnit(${row.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            }
        ]
    });

    // Load subjects for the dropdowns
    loadSubjects();
});

function showAddModal() {
    $('#unitForm')[0].reset();
    $('#unitId').val('');
    $('#modalTitle').text('Yeni Ünite');
    $('#unitModal').modal('show');
}

function loadSubjects() {
    // Load active subjects for the dropdowns
    fetch('/api/admin/subjects/active')
        .then(response => response.json())
        .then(data => {
            const filterSelect = $('#subjectFilter');
            const formSelect = $('#subjectSelect');
            
            // Clear and add default options
            filterSelect.empty().append('<option value="">Tüm Dersler</option>');
            formSelect.empty().append('<option value="">Ders seçiniz</option>');
            
            // Populate both selects
            data.data.forEach(subject => {
                const option = `<option value="${subject.id}">${subject.name} (${subject.grade_name})</option>`;
                filterSelect.append(option);
                formSelect.append(option);
            });
        });
}

function loadUnits() {
    const subjectId = $('#subjectFilter').val();
    const url = subjectId ? `/api/admin/units?subject_id=${subjectId}` : '/api/admin/units';
    
    $('#unitsTable').DataTable().ajax.url(url).load();
}

function saveUnit() {
    const unitData = {
        id: $('#unitId').val() || null,
        name: $('#unitName').val(),
        subject_id: $('#subjectSelect').val(),
        order_number: $('#orderNumber').val(),
        is_active: $('#isActive').is(':checked')
    };

    const method = unitData.id ? 'PUT' : 'POST';
    const url = unitData.id ? 
        `/api/admin/units/${unitData.id}` : 
        '/api/admin/units';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(unitData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#unitModal').modal('hide');
            $('#unitsTable').DataTable().ajax.reload();
            showToast('Başarılı', 'Ünite başarıyla kaydedildi.', 'success');
        } else {
            showToast('Hata', data.message || 'Bir hata oluştu.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Hata', 'Bir hata oluştu.', 'error');
    });
}

function editUnit(id) {
    fetch(`/api/admin/units/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const unit = data.data;
                $('#unitId').val(unit.id);
                $('#unitName').val(unit.name);
                $('#subjectSelect').val(unit.subject_id);
                $('#orderNumber').val(unit.order_number);
                $('#isActive').prop('checked', unit.is_active);
                
                $('#modalTitle').text('Düzenle: ' + unit.name);
                $('#unitModal').modal('show');
            }
        });
}

function deleteUnit(id) {
    if (confirm('Bu üniteyi silmek istediğinize emin misiniz? Bu işlem geri alınamaz!')) {
        fetch(`/api/admin/units/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#unitsTable').DataTable().ajax.reload();
                showToast('Başarılı', 'Ünite başarıyla silindi.', 'success');
            } else {
                showToast('Hata', data.message || 'Bir hata oluştu.', 'error');
            }
        });
    }
}
</script>
{% endblock %}
