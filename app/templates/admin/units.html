{% extends "admin/base_admin.html" %}

{% block title %}Ünite Yönetimi{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Ünite Yönetimi</li>
{% endblock %}

{% block page_title %}Ünite Yönetimi{% endblock %}
{% block page_subtitle %}Üniteleri ekleyin, düzenleyin ve yönetin{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" onclick="showCreateUnitModal()">
    <i class="fas fa-plus me-2"></i>Yeni Ünite
</button>
<button class="btn btn-outline-primary" onclick="exportUnits()">
    <i class="fas fa-download me-2"></i>Export
</button>
{% endblock %}

{% block content %}
<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="search-box">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="search-units" placeholder="Ünite ara..." data-target="units-table">
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="filter-box">
            <select class="form-select" id="grade-filter">
                <option value="">Tüm Sınıflar</option>
                <!-- Sınıflar JavaScript ile doldurulacak -->
            </select>
        </div>
    </div>
    <div class="col-md-3">
        <div class="filter-box">
            <select class="form-select" id="subject-filter">
                <option value="">Tüm Dersler</option>
                <!-- Dersler JavaScript ile doldurulacak -->
            </select>
        </div>
    </div>
    <div class="col-md-3">
        <div class="filter-box">
            <select class="form-select" id="status-filter">
                <option value="">Tüm Durumlar</option>
                <option value="active">Aktif</option>
                <option value="inactive">Pasif</option>
            </select>
        </div>
    </div>
</div>

<!-- Units Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>Ünite Listesi
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="units-table">
                <thead>
                    <tr>
                        <th>Sıra</th>
                        <th>Ünite Adı</th>
                        <th>Sınıf</th>
                        <th>Ders</th>
                        <th>Açıklama</th>
                        <th>Konu Sayısı</th>
                        <th>Durum</th>
                        <th>Oluşturulma</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="units-tbody">
                    <!-- Üniteler JavaScript ile doldurulacak -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="Ünite sayfaları" class="mt-4">
            <ul class="pagination justify-content-center" id="units-pagination">
                <!-- Sayfalama JavaScript ile doldurulacak -->
            </ul>
        </nav>
    </div>
</div>

<!-- Create/Edit Unit Modal -->
<div class="modal fade" id="unitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unitModalTitle">Yeni Ünite Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="unitForm">
                <div class="modal-body">
                    <input type="hidden" id="unit-id" name="id">
                    
                    <div class="mb-3">
                        <label for="unit-name" class="form-label">Ünite Adı *</label>
                        <input type="text" class="form-control" id="unit-name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="unit-grade" class="form-label">Sınıf *</label>
                        <select class="form-select" id="unit-grade" name="grade_id" required>
                            <option value="">Sınıf seçin</option>
                            <!-- Sınıflar JavaScript ile doldurulacak -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="unit-subject" class="form-label">Ders *</label>
                        <select class="form-select" id="unit-subject" name="subject_id" required>
                            <option value="">Önce sınıf seçin</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="unit-description" class="form-label">Açıklama</label>
                        <textarea class="form-control" id="unit-description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="unit-order" class="form-label">Sıra Numarası</label>
                        <input type="number" class="form-control" id="unit-order" name="order_number" min="1">
                        <div class="form-text">Ünitenin görüntülenme sırası</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="unit-active" name="is_active" checked>
                            <label class="form-check-label" for="unit-active">
                                Aktif
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Units Management JavaScript
class UnitsManager {
    constructor() {
        this.currentPage = 1;
        this.perPage = 10;
        this.units = [];
        this.grades = [];
        this.subjects = [];
        this.filteredUnits = [];
        this.init();
    }

    init() {
        this.loadGrades();
        this.loadUnits();
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Search
        const searchInput = document.getElementById('search-units');
        if (searchInput) {
            searchInput.addEventListener('input', this.debounce((e) => {
                this.filterUnits();
            }, 300));
        }

        // Grade filter
        const gradeFilter = document.getElementById('grade-filter');
        if (gradeFilter) {
            gradeFilter.addEventListener('change', () => {
                this.updateSubjectFilter();
                this.filterUnits();
            });
        }

        // Subject filter
        const subjectFilter = document.getElementById('subject-filter');
        if (subjectFilter) {
            subjectFilter.addEventListener('change', () => {
                this.filterUnits();
            });
        }

        // Status filter
        const statusFilter = document.getElementById('status-filter');
        if (statusFilter) {
            statusFilter.addEventListener('change', () => {
                this.filterUnits();
            });
        }

        // Form submit
        const unitForm = document.getElementById('unitForm');
        if (unitForm) {
            unitForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveUnit();
            });
        }

        // Grade change in modal
        const unitGrade = document.getElementById('unit-grade');
        if (unitGrade) {
            unitGrade.addEventListener('change', () => {
                this.updateModalSubjectFilter();
            });
        }
    }

    async loadGrades() {
        try {
            const response = await fetch('/api/admin/grades');
            const data = await response.json();
            
            if (data.success) {
                this.grades = data.data || [];
                this.populateGradeFilters();
            }
        } catch (error) {
            console.error('Sınıf yükleme hatası:', error);
        }
    }

    async loadSubjects() {
        try {
            const response = await fetch('/admin/api/subjects');
            const data = await response.json();
            
            if (data.success) {
                this.subjects = data.data || [];
            }
        } catch (error) {
            console.error('Ders yükleme hatası:', error);
        }
    }

    populateGradeFilters() {
        const gradeFilter = document.getElementById('grade-filter');
        const unitGrade = document.getElementById('unit-grade');
        
        if (gradeFilter) {
            gradeFilter.innerHTML = '<option value="">Tüm Sınıflar</option>';
            this.grades.forEach(grade => {
                gradeFilter.innerHTML += `<option value="${grade.id}">${grade.name}</option>`;
            });
        }
        
        if (unitGrade) {
            unitGrade.innerHTML = '<option value="">Sınıf seçin</option>';
            this.grades.forEach(grade => {
                unitGrade.innerHTML += `<option value="${grade.id}">${grade.name}</option>`;
            });
        }
    }

    updateSubjectFilter() {
        const gradeFilter = document.getElementById('grade-filter');
        const subjectFilter = document.getElementById('subject-filter');
        
        if (!gradeFilter || !subjectFilter) return;
        
        const selectedGradeId = gradeFilter.value;
        subjectFilter.innerHTML = '<option value="">Tüm Dersler</option>';
        
        if (selectedGradeId) {
            const gradeSubjects = this.subjects.filter(subject => subject.grade_id == selectedGradeId);
            gradeSubjects.forEach(subject => {
                subjectFilter.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
            });
        }
    }

    updateModalSubjectFilter() {
        const unitGrade = document.getElementById('unit-grade');
        const unitSubject = document.getElementById('unit-subject');
        
        if (!unitGrade || !unitSubject) return;
        
        const selectedGradeId = unitGrade.value;
        unitSubject.innerHTML = '<option value="">Ders seçin</option>';
        
        if (selectedGradeId) {
            const gradeSubjects = this.subjects.filter(subject => subject.grade_id == selectedGradeId);
            gradeSubjects.forEach(subject => {
                unitSubject.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
            });
        }
    }

    async loadUnits() {
        try {
            showLoading('Üniteler yükleniyor...');
            
            const response = await fetch('/admin/api/units');
            const data = await response.json();
            
            if (data.success) {
                this.units = data.data || [];
                this.filteredUnits = [...this.units];
                this.renderUnits();
            } else {
                showToast('Üniteler yüklenemedi', 'error');
            }
        } catch (error) {
            console.error('Ünite yükleme hatası:', error);
            showToast('Üniteler yüklenirken hata oluştu', 'error');
        } finally {
            hideLoading();
        }
    }

    filterUnits() {
        const searchTerm = document.getElementById('search-units').value.toLowerCase();
        const gradeFilter = document.getElementById('grade-filter').value;
        const subjectFilter = document.getElementById('subject-filter').value;
        const statusFilter = document.getElementById('status-filter').value;
        
        this.filteredUnits = this.units.filter(unit => {
            const matchesSearch = unit.name.toLowerCase().includes(searchTerm) ||
                                unit.description.toLowerCase().includes(searchTerm);
            
            const matchesGrade = !gradeFilter || unit.grade_id == gradeFilter;
            const matchesSubject = !subjectFilter || unit.subject_id == subjectFilter;
            
            const matchesStatus = !statusFilter || 
                                (statusFilter === 'active' && unit.is_active) ||
                                (statusFilter === 'inactive' && !unit.is_active);
            
            return matchesSearch && matchesGrade && matchesSubject && matchesStatus;
        });
        
        this.currentPage = 1;
        this.renderUnits();
    }

    renderUnits() {
        const tbody = document.getElementById('units-tbody');
        if (!tbody) return;

        const startIndex = (this.currentPage - 1) * this.perPage;
        const endIndex = startIndex + this.perPage;
        const pageUnits = this.filteredUnits.slice(startIndex, endIndex);

        tbody.innerHTML = '';

        if (pageUnits.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>Ünite bulunamadı</p>
                    </td>
                </tr>
            `;
            return;
        }

        pageUnits.forEach(unit => {
            const row = this.createUnitRow(unit);
            tbody.appendChild(row);
        });

        this.renderPagination();
    }

    createUnitRow(unit) {
        const grade = this.grades.find(g => g.id === unit.grade_id);
        const subject = this.subjects.find(s => s.id === unit.subject_id);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${unit.order_number || '-'}</td>
            <td>
                <strong>${unit.name}</strong>
            </td>
            <td>
                <span class="badge bg-primary">${grade ? grade.name : 'Bilinmiyor'}</span>
            </td>
            <td>
                <span class="badge bg-success">${subject ? subject.name : 'Bilinmiyor'}</span>
            </td>
            <td>${unit.description || '-'}</td>
            <td>
                <span class="badge bg-info">${unit.topic_count || 0}</span>
            </td>
            <td>
                <span class="badge bg-${unit.is_active ? 'success' : 'secondary'}">
                    ${unit.is_active ? 'Aktif' : 'Pasif'}
                </span>
            </td>
            <td>${this.formatDate(unit.created_at)}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="unitsManager.editUnit(${unit.id})" title="Düzenle">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-${unit.is_active ? 'warning' : 'success'}" 
                            onclick="unitsManager.toggleUnitStatus(${unit.id})" 
                            title="${unit.is_active ? 'Pasif Yap' : 'Aktif Yap'}">
                        <i class="fas fa-${unit.is_active ? 'toggle-off' : 'toggle-on'}"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="unitsManager.deleteUnit(${unit.id})" title="Sil">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        return row;
    }

    renderPagination() {
        const pagination = document.getElementById('units-pagination');
        if (!pagination) return;

        const totalPages = Math.ceil(this.filteredUnits.length / this.perPage);
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let paginationHTML = '';

        // Previous button
        paginationHTML += `
            <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="unitsManager.goToPage(${this.currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                paginationHTML += `
                    <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="unitsManager.goToPage(${i})">${i}</a>
                    </li>
                `;
            } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        // Next button
        paginationHTML += `
            <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="unitsManager.goToPage(${this.currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

        pagination.innerHTML = paginationHTML;
    }

    goToPage(page) {
        const totalPages = Math.ceil(this.filteredUnits.length / this.perPage);
        if (page < 1 || page > totalPages) return;
        
        this.currentPage = page;
        this.renderUnits();
    }

    showCreateModal() {
        document.getElementById('unitModalTitle').textContent = 'Yeni Ünite Ekle';
        document.getElementById('unitForm').reset();
        document.getElementById('unit-id').value = '';
        document.getElementById('unit-subject').innerHTML = '<option value="">Önce sınıf seçin</option>';
        
        const modal = new bootstrap.Modal(document.getElementById('unitModal'));
        modal.show();
    }

    editUnit(unitId) {
        const unit = this.units.find(u => u.id === unitId);
        if (!unit) return;

        document.getElementById('unitModalTitle').textContent = 'Ünite Düzenle';
        document.getElementById('unit-id').value = unit.id;
        document.getElementById('unit-name').value = unit.name;
        document.getElementById('unit-grade').value = unit.grade_id;
        document.getElementById('unit-description').value = unit.description || '';
        document.getElementById('unit-order').value = unit.order_number || '';
        document.getElementById('unit-active').checked = unit.is_active;

        // Update subject filter for selected grade
        this.updateModalSubjectFilter();
        document.getElementById('unit-subject').value = unit.subject_id;

        const modal = new bootstrap.Modal(document.getElementById('unitModal'));
        modal.show();
    }

    async saveUnit() {
        try {
            const formData = new FormData(document.getElementById('unitForm'));
            const unitData = {
                name: formData.get('name'),
                grade_id: parseInt(formData.get('grade_id')),
                subject_id: parseInt(formData.get('subject_id')),
                description: formData.get('description'),
                order_number: parseInt(formData.get('order_number')) || null,
                is_active: formData.get('is_active') === 'on'
            };

            const unitId = formData.get('id');
            const url = unitId ? `/admin/api/units/${unitId}` : '/admin/api/units';
            const method = unitId ? 'PUT' : 'POST';

            showLoading('Ünite kaydediliyor...');

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(unitData)
            });

            const data = await response.json();

            if (data.success) {
                showToast(unitId ? 'Ünite güncellendi' : 'Ünite eklendi', 'success');
                bootstrap.Modal.getInstance(document.getElementById('unitModal')).hide();
                this.loadUnits();
            } else {
                showToast(data.message || 'Ünite kaydedilemedi', 'error');
            }
        } catch (error) {
            console.error('Ünite kaydetme hatası:', error);
            showToast('Ünite kaydedilirken hata oluştu', 'error');
        } finally {
            hideLoading();
        }
    }

    async toggleUnitStatus(unitId) {
        try {
            const unit = this.units.find(u => u.id === unitId);
            if (!unit) return;

            const newStatus = !unit.is_active;
            const action = newStatus ? 'aktif' : 'pasif';

            if (!confirm(`Bu üniteyi ${action} yapmak istediğinizden emin misiniz?`)) {
                return;
            }

            showLoading('Durum güncelleniyor...');

            const response = await fetch(`/admin/api/units/${unitId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    is_active: newStatus
                })
            });

            const data = await response.json();

            if (data.success) {
                showToast(`Ünite ${action} yapıldı`, 'success');
                this.loadUnits();
            } else {
                showToast('Durum güncellenemedi', 'error');
            }
        } catch (error) {
            console.error('Durum güncelleme hatası:', error);
            showToast('Durum güncellenirken hata oluştu', 'error');
        } finally {
            hideLoading();
        }
    }

    async deleteUnit(unitId) {
        try {
            if (!confirm('Bu üniteyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                return;
            }

            showLoading('Ünite siliniyor...');

            const response = await fetch(`/admin/api/units/${unitId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showToast('Ünite silindi', 'success');
                this.loadUnits();
            } else {
                showToast('Ünite silinemedi', 'error');
            }
        } catch (error) {
            console.error('Ünite silme hatası:', error);
            showToast('Ünite silinirken hata oluştu', 'error');
        } finally {
            hideLoading();
        }
    }

    exportUnits() {
        const csvData = this.filteredUnits.map(unit => {
            const grade = this.grades.find(g => g.id === unit.grade_id);
            const subject = this.subjects.find(s => s.id === unit.subject_id);
            return {
                'Sıra': unit.order_number || '',
                'Ünite Adı': unit.name,
                'Sınıf': grade ? grade.name : 'Bilinmiyor',
                'Ders': subject ? subject.name : 'Bilinmiyor',
                'Açıklama': unit.description || '',
                'Durum': unit.is_active ? 'Aktif' : 'Pasif',
                'Oluşturulma': this.formatDate(unit.created_at)
            };
        });

        window.exportToCSV(csvData, 'uniteler.csv');
    }

    formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString('tr-TR');
    }

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// Global functions
function showCreateUnitModal() {
    if (window.unitsManager) {
        window.unitsManager.showCreateModal();
    }
}

function exportUnits() {
    if (window.unitsManager) {
        window.unitsManager.exportUnits();
    }
}

// Units manager'ı başlat
document.addEventListener('DOMContentLoaded', () => {
    window.unitsManager = new UnitsManager();
});
</script>
{% endblock %}
