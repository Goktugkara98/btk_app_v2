{% extends "admin/base_admin.html" %}

{% block page_title %}Konu Yönetimi{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('pages.admin_pages.curriculum_management') }}">Müfredat</a></li>
    <li class="breadcrumb-item active">Konular</li>
{% endblock %}

{% block page_actions %}
<button class="btn btn-primary" onclick="showAddModal()">
    <i class="fas fa-plus"></i> Yeni Konu
</button>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-list"></i> Konu Listesi
        </h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="unitFilter" class="form-label">Ünite Seçiniz</label>
                <select class="form-select" id="unitFilter" onchange="loadTopics()">
                    <option value="">Tüm Üniteler</option>
                    <!-- Units will be populated by JavaScript -->
                </select>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover" id="topicsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Konu Adı</th>
                        <th>Ünite</th>
                        <th>Ders</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="topicModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Yeni Konu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="topicForm">
                    <input type="hidden" id="topicId">
                    <div class="mb-3">
                        <label for="topicName" class="form-label">Konu Adı</label>
                        <input type="text" class="form-control" id="topicName" required>
                    </div>
                    <div class="mb-3">
                        <label for="unitSelect" class="form-label">Ünite</label>
                        <select class="form-select" id="unitSelect" required>
                            <option value="">Ünite seçiniz</option>
                            <!-- Units will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Açıklama</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="isActive" checked>
                        <label class="form-check-label" for="isActive">Aktif</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveButton" onclick="saveTopic()">Kaydet</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Initialize the page when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize DataTable
    const topicsTable = $('#topicsTable').DataTable({
        ajax: {
            url: '/api/admin/topics',
            dataSrc: 'data'
        },
        columns: [
            { data: 'topic_id' },
            { data: 'topic_name' },
            { data: 'unit_name' },
            { data: 'subject_name' },
            { 
                data: 'is_active',
                render: function(data, type, row) {
                    return data ? 
                        '<span class="badge bg-success">Aktif</span>' : 
                        '<span class="badge bg-danger">Pasif</span>';
                }
            },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    return `
                        <button class="btn btn-sm btn-outline-primary" onclick="editTopic(${row.topic_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTopic(${row.topic_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            }
        ]
    });

    // Load units for the dropdowns
    loadUnits();
});

function showAddModal() {
    $('#topicForm')[0].reset();
    $('#topicId').val('');
    $('#modalTitle').text('Yeni Konu');
    $('#topicModal').modal('show');
}

function loadUnits() {
    // Load all units for the dropdowns
    fetch('/api/admin/units')
        .then(response => response.json())
        .then(data => {
            const filterSelect = $('#unitFilter');
            const formSelect = $('#unitSelect');
            
            // Clear and add default options
            filterSelect.empty().append('<option value="">Tüm Üniteler</option>');
            formSelect.empty().append('<option value="">Ünite seçiniz</option>');
            
            // Populate both selects
            data.data.forEach(unit => {
                const option = `<option value="${unit.unit_id}">${unit.unit_name} (${unit.subject_name})</option>`;
                filterSelect.append(option);
                formSelect.append(option);
            });
        });
}

function loadTopics() {
    const unitId = $('#unitFilter').val();
    const url = unitId ? `/api/admin/topics?unit_id=${unitId}` : '/api/admin/topics';
    
    $('#topicsTable').DataTable().ajax.url(url).load();
}

function saveTopic() {
    const topicData = {
        id: $('#topicId').val() || null,
        topic_name: $('#topicName').val(),
        unit_id: $('#unitSelect').val(),
        description: $('#description').val(),
        is_active: $('#isActive').is(':checked')
    };

    const method = topicData.id ? 'PUT' : 'POST';
    const url = topicData.id ? 
        `/api/admin/topics/${topicData.id}` : 
        '/api/admin/topics';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(topicData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#topicModal').modal('hide');
            $('#topicsTable').DataTable().ajax.reload();
            showToast('Başarılı', 'Konu başarıyla kaydedildi.', 'success');
        } else {
            showToast('Hata', data.message || 'Bir hata oluştu.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Hata', 'Bir hata oluştu.', 'error');
    });
}

function editTopic(id) {
    fetch(`/api/admin/topics/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const topic = data.data;
                $('#topicId').val(topic.topic_id);
                $('#topicName').val(topic.topic_name);
                $('#unitSelect').val(topic.unit_id);
                $('#description').val(topic.description);
                $('#isActive').prop('checked', topic.is_active);
                
                $('#modalTitle').text('Düzenle: ' + topic.topic_name);
                $('#topicModal').modal('show');
            }
        });
}

function deleteTopic(id) {
    if (confirm('Bu konuyu silmek istediğinize emin misiniz? Bu işlem geri alınamaz!')) {
        fetch(`/api/admin/topics/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#topicsTable').DataTable().ajax.reload();
                showToast('Başarılı', 'Konu başarıyla silindi.', 'success');
            } else {
                showToast('Hata', data.message || 'Bir hata oluştu.', 'error');
            }
        });
    }
}
</script>
{% endblock %}
