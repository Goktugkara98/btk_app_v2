<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend AI Chat Message Packaging Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>Frontend AI Chat Message Packaging Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Direct Message Packaging</h2>
        <button onclick="testDirectMessage()">Test Direct Message</button>
        <div id="directMessageResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Quick Action Packaging</h2>
        <button onclick="testQuickAction()">Test Quick Action</button>
        <div id="quickActionResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Wrong Answer Packaging</h2>
        <button onclick="testWrongAnswer()">Test Wrong Answer</button>
        <div id="wrongAnswerResult" class="result"></div>
    </div>

    <script>
        // Mock AIChatService for testing
        class MockAIChatService {
            getCurrentQuestionData() {
                return {
                    id: 123,
                    question_text: "Test soru metni",
                    options: [
                        { id: 1, option_text: "Seçenek A" },
                        { id: 2, option_text: "Seçenek B" },
                        { id: 3, option_text: "Seçenek C" },
                        { id: 4, option_text: "Seçenek D" }
                    ]
                };
            }

            async sendChatMessage(messageData) {
                console.log('sendChatMessage called with:', messageData);
                return { success: true, message: 'Mock AI response' };
            }

            async sendQuickAction(actionData) {
                console.log('sendQuickAction called with:', actionData);
                return { success: true, message: 'Mock quick action response' };
            }
        }

        const mockService = new MockAIChatService();

        function testDirectMessage() {
            try {
                // Simulate direct message packaging
                const messageData = {
                    message: "Bu soruyu nasıl çözebilirim?",
                    questionId: 123,
                    isFirstMessage: true,
                    scenarioType: 'direct',
                    questionContext: mockService.getCurrentQuestionData(),
                    userAction: {
                        type: 'direct_message',
                        trigger: 'user_input',
                        context: {
                            inputMethod: 'text_input',
                            messageLength: 25
                        }
                    }
                };

                // Validate structure
                const isValid = validateMessageStructure(messageData);
                displayResult('directMessageResult', isValid, messageData);
            } catch (error) {
                displayError('directMessageResult', error);
            }
        }

        function testQuickAction() {
            try {
                // Simulate quick action packaging
                const actionData = {
                    action: 'explain',
                    questionId: 123,
                    isFirstMessage: false,
                    questionContext: mockService.getCurrentQuestionData(),
                    userAction: {
                        type: 'quick_action',
                        trigger: 'button_click',
                        action_name: 'explain',
                        context: {
                            buttonId: 'quick-action-explain',
                            timestamp: Date.now()
                        }
                    }
                };

                // Validate structure
                const isValid = validateActionStructure(actionData);
                displayResult('quickActionResult', isValid, actionData);
            } catch (error) {
                displayError('quickActionResult', error);
            }
        }

        function testWrongAnswer() {
            try {
                // Simulate wrong answer packaging
                const messageData = {
                    message: "Kullanıcı yanlış cevap verdi. Soru ID: 123, Kullanıcının cevabı: Seçenek A (id:1), Doğru cevap: Seçenek C (id:3). Lütfen bu yanlış cevabı analiz et ve kullanıcıya yardımcı ol.",
                    questionId: 123,
                    isFirstMessage: true,
                    scenarioType: 'wrong_answer',
                    questionContext: mockService.getCurrentQuestionData(),
                    userAction: {
                        type: 'wrong_answer',
                        trigger: 'auto_trigger',
                        context: {
                            selectedAnswer: "Seçenek A (id:1)",
                            correctAnswer: "Seçenek C (id:3)",
                            timestamp: Date.now()
                        }
                    }
                };

                // Validate structure
                const isValid = validateMessageStructure(messageData);
                displayResult('wrongAnswerResult', isValid, messageData);
            } catch (error) {
                displayError('wrongAnswerResult', error);
            }
        }

        function validateMessageStructure(data) {
            const required = ['message', 'questionId', 'isFirstMessage', 'scenarioType', 'questionContext', 'userAction'];
            const userActionRequired = ['type', 'trigger', 'context'];
            
            for (let field of required) {
                if (!(field in data)) {
                    throw new Error(`Missing required field: ${field}`);
                }
            }
            
            for (let field of userActionRequired) {
                if (!(field in data.userAction)) {
                    throw new Error(`Missing required userAction field: ${field}`);
                }
            }
            
            return true;
        }

        function validateActionStructure(data) {
            const required = ['action', 'questionId', 'isFirstMessage', 'questionContext', 'userAction'];
            const userActionRequired = ['type', 'trigger', 'context'];
            
            for (let field of required) {
                if (!(field in data)) {
                    throw new Error(`Missing required field: ${field}`);
                }
            }
            
            for (let field of userActionRequired) {
                if (!(field in data.userAction)) {
                    throw new Error(`Missing required userAction field: ${field}`);
                }
            }
            
            return true;
        }

        function displayResult(elementId, isValid, data) {
            const element = document.getElementById(elementId);
            element.className = 'result ' + (isValid ? 'success' : 'error');
            element.innerHTML = `
                <h4>${isValid ? '✅ Test Passed' : '❌ Test Failed'}</h4>
                <h5>Data Structure:</h5>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        function displayError(elementId, error) {
            const element = document.getElementById(elementId);
            element.className = 'result error';
            element.innerHTML = `
                <h4>❌ Test Failed</h4>
                <p><strong>Error:</strong> ${error.message}</p>
            `;
        }
    </script>
</body>
</html>
